name: Build Angular & Upload to Pinata (IPFS)

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-pin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Build (Angular for root domain/IPFS)
        run: |
          # IPFS serves at the root, so base-href should be "/"
          npx ng build --configuration=production --base-href="/"

      - name: Locate build output
        id: out
        shell: bash
        run: |
          BUILD_DIR=$(find dist -type f -name index.html -printf '%h\n' | head -n1)
          if [ -z "$BUILD_DIR" ]; then
            echo "No build output found under dist/"
            exit 1
          fi
          echo "dir=$BUILD_DIR" >> "$GITHUB_OUTPUT"
          echo "Detected BUILD_DIR=$BUILD_DIR"

      - name: Add SPA fallback (copy index -> 404 for router refresh)
        run: cp "${{ steps.out.outputs.dir }}/index.html" "${{ steps.out.outputs.dir }}/404.html"

      - name: Install Pinata CLI
        run: npm i -g @pinata/cli

      - name: Authenticate Pinata
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}
        run: |
          pinata auth set --jwt "$PINATA_JWT"
          pinata whoami

      - name: Upload dist/ to Pinata (as a directory)
        id: pin
        run: |
          # Upload the built directory; disable extra wrapping so the CID points at the site root
          CID=$(pinata upload "${{ steps.out.outputs.dir }}" --wrap-with-directory false --name "zouriel-portfolio-${{ github.sha }}" --json | jq -r '.cid // .IpfsHash // .cidV1')
          if [ -z "$CID" ] || [ "$CID" = "null" ]; then
            echo "Failed to parse CID from Pinata response"
            exit 1
          fi
          echo "cid=$CID" >> "$GITHUB_OUTPUT"
          echo "Pinned CID: $CID"

      - name: Summarise deployment (CID + gateways)
        run: |
          echo "CID: ${{ steps.pin.outputs.cid }}"
          echo "Public gateways (try any):"
          echo " - https://gateway.pinata.cloud/ipfs/${{ steps.pin.outputs.cid }}/"
          echo " - https://ipfs.io/ipfs/${{ steps.pin.outputs.cid }}/"
          echo " - https://cloudflare-ipfs.com/ipfs/${{ steps.pin.outputs.cid }}/"

      - name: Comment CID on commit
        uses: peter-evans/commit-comment@v3
        with:
          body: |
            âœ… Pinned to IPFS via Pinata.
            **CID:** `${{ steps.pin.outputs.cid }}`
            **Preview:** https://gateway.pinata.cloud/ipfs/${{ steps.pin.outputs.cid }}/
